# Дмитрий Воловиков - "LyceumDocBot"

# Пользовательские сценарии

### Группа: 11 - И - 1

### Электронная почта: volovikov.dvs@gmail.com

### Tg: @Pug0077


**FR1. Аккаунт пользователя:** пользователь регистрируется, входит/выходит из аккаунта, редактирует параметры профиля и меняет пароль в профиле.
**FR2. Чат-запрос:** пользователь задаёт вопрос к базе документов в интерфейсе чата.
**FR3. Ответ с доказательствами:** система формирует ответ только на основе документов, добавляет ссылки-цитаты вида `[S#]`, а при недостатке данных сообщает «не знаю» и предлагает уточнить запрос; система использует MVP-проверку наличия и корректности ссылок `[S#]`.
**FR4. Просмотр источников:** пользователь открывает источники из ответа и переходит к фрагменту в viewer (по извлечённому тексту) с подсветкой; при необходимости открывает оригинальный PDF.
**FR5. Поиск по документам:** пользователь выполняет поиск по ключевым словам по корпусу документов с фильтрами (например, категория/тип).
**FR6. История запросов:** пользователь просматривает историю, открывает прошлые ответы, повторяет запрос и удаляет записи из своей истории.
**FR7. Экспорт:** пользователь экспортирует ответ в PDF вместе с источниками.
**FR8. Загрузка документов (админ):** администратор загружает документы, задаёт метаданные и запускает индексацию; после успешной индексации документ переходит в статус `review`.
**FR9. Модерация документов (админ):** администратор публикует/отклоняет документ (с причиной) и удаляет документ из системы.
**FR10. Управление пользователями (админ):** администратор управляет пользователями (роль **user/admin**), блокирует/разблокирует аккаунты и выполняет сброс пароля (генерация временного пароля) с обязательной сменой при первом входе.

### Сценарий 1 — FR1: Регистрация, вход/выход, профиль и смена пароля

1. **Пользователь открывает** страницу входа и выбирает «Регистрация».
2. **Пользователь вводит** имя (или отображаемое имя), email и пароль и нажимает «Создать аккаунт».
3. **Система проверяет** корректность email и правила пароля и **показывает** ошибки, если данные неверны.
4. **Система создаёт** аккаунт и **перенаправляет** пользователя на страницу входа.
5. **Пользователь вводит** email и пароль и нажимает «Войти».
6. **Система создаёт** сессию и **открывает** страницу `/chat`, а при неверных данных **показывает** сообщение об ошибке.
7. **Пользователь открывает** «Профиль» и **изменяет** параметры (например, имя) и сохраняет.
8. **Пользователь выбирает** «Сменить пароль», вводит старый и новый пароль и подтверждает.
9. **Система проверяет** старый пароль и сложность нового, сохраняет изменения или **показывает** ошибку.


### Сценарий 2 — FR2: Вопрос в чате

1. **Пользователь открывает** страницу «Чат с документами».
2. **Пользователь вводит** вопрос в поле ввода и нажимает «Отправить».
3. **Система валидирует** вопрос (не пустой, не превышает лимит) и **показывает** ошибку при нарушении.
4. **Система создаёт** запись запроса в базе данных и присваивает ему ID.
5. **Система показывает** индикатор обработки и временно **блокирует** повторную отправку.
6. **Система отображает** ответ ассистента в чате.
7. **Система отображает** панель источников/кнопку «Источники» рядом с ответом.
8. **Пользователь задаёт** уточняющий вопрос и отправляет его повторно.


### Сценарий 3 — FR3: Ответ только по документам + цитаты + «не знаю» (MVP-проверка)

1. **Пользователь задаёт** вопрос, который требует подтверждения документом.
2. **Система выполняет** поиск релевантных фрагментов в корпусе документов.
3. **Система формирует** контекст из найденных фрагментов и подготавливает запрос к LLM.
4. **Система генерирует** ответ и формирует список источников `S1..Sk` для цитирования.
5. **Система проверяет**, что ответ содержит минимум N ссылок вида `[S#]` и что каждая ссылка соответствует существующему источнику из `S1..Sk`.
6. **Система выполняет** одну перегенерацию ответа при нарушении правила, а при повторном нарушении **показывает** «Не знаю, в документах нет подтверждения» и совет по уточнению запроса.
7. **Система сохраняет** финальный результат (вопрос, ответ, источники) в базе данных.
8. **Пользователь читает** ответ и при необходимости уточняет вопрос.


### Сценарий 4 — FR4: Переход к источнику и фрагменту (viewer извлечённого текста)

1. **Пользователь нажимает** на ссылку источника `[S1]` в ответе.
2. **Система открывает** карточку источника (название документа, страница/раздел, сниппет).
3. **Пользователь нажимает** «Открыть фрагмент».
4. **Система открывает** viewer с извлечённым текстом и **подсвечивает** релевантный фрагмент.
5. **Система показывает** кнопку «Открыть оригинальный PDF» и открывает PDF в отдельном просмотре по запросу пользователя.
6. **Система показывает** сообщение об ошибке, если документ недоступен, и предлагает вернуться к списку источников.
7. **Пользователь переключает** источники `[S2]`, `[S3]` и сравнивает подтверждения.
8. **Пользователь копирует** ссылку на просмотр фрагмента (например, `/doc/:docId?sourceId=...`) для использования вне системы.
9. **Система фиксирует** факт открытия источника (для внутренней статистики).


### Сценарий 5 — FR5: Поиск по ключевым словам с фильтрами

1. **Пользователь открывает** раздел «Поиск по документам».
2. **Пользователь вводит** ключевую фразу и нажимает «Найти».
3. **Система выполняет** поиск и **показывает** список совпадений со сниппетами и метаданными документа.
4. **Пользователь выбирает** фильтр (например, категория документа).
5. **Система обновляет** выдачу и отображает новое количество результатов.
6. **Пользователь открывает** один из результатов.
7. **Система показывает** viewer извлечённого текста и подсвечивает найденный фрагмент.
8. **Система показывает** «Ничего не найдено» и советы по уточнению, если результатов нет.
9. **Пользователь уточняет** запрос и повторяет поиск.


### Сценарий 6 — FR6: История запросов + повтор + удаление

1. **Пользователь открывает** раздел «История запросов».
2. **Система отображает** список запросов с датой, превью и статусом.
3. **Пользователь выбирает** один запрос из списка.
4. **Система открывает** сохранённый ответ и источники без повторной генерации.
5. **Пользователь нажимает** «Повторить запрос», чтобы получить обновлённый ответ по актуальному корпусу.
6. **Система запускает** повторную обработку и сохраняет новую версию ответа.
7. **Система отображает** ошибку и кнопку «Повторить», если повторная обработка завершилась неуспешно.
8. **Пользователь нажимает** «Удалить» у записи истории и подтверждает действие.
9. **Система удаляет** запись из истории пользователя и обновляет список.


### Сценарий 7 — FR7: Экспорт ответа в PDF

1. **Пользователь открывает** ответ (в чате или в истории).
2. **Пользователь нажимает** кнопку «Экспорт в PDF».
3. **Система формирует** PDF-файл с вопросом, ответом и списком источников.
4. **Система добавляет** в PDF сведения об источниках: `[S#]`, документ, страница/раздел (или идентификатор фрагмента).
5. **Система показывает** пользователю кнопку «Скачать PDF».
6. **Пользователь скачивает** PDF на устройство.
7. **Система сохраняет** факт экспорта (дата, запрос, версия ответа).
8. **Система показывает** сообщение об ошибке и кнопку «Повторить», если генерация PDF не удалась.


### Сценарий 8 — FR8: Загрузка документа и индексация (админ, статус review после успеха)

1. **Администратор открывает** раздел «Документы» в админ-панели.
2. **Администратор нажимает** «Загрузить документ» и выбирает файл.
3. **Система валидирует** формат/размер и **показывает** ошибку, если файл не подходит.
4. **Администратор вводит** метаданные (название, категория) и подтверждает загрузку.
5. **Система сохраняет** файл на сервере и создаёт запись документа со статусом `indexing`.
6. **Система извлекает** текст, режет на чанки и обновляет индексы для поиска/RAG.
7. **Система переводит** документ в статус `review` после успешной индексации.
8. **Система переводит** документ в статус `error` и показывает причину, если индексация не удалась.
9. **Администратор запускает** повторную индексацию для документа со статусом `error`.


### Сценарий 9 — FR9: Модерация документов (админ)

1. **Администратор открывает** раздел «Модерация» и выбирает документы со статусом `review`.
2. **Администратор открывает** карточку документа для проверки.
3. **Система показывает** метаданные документа и превью содержимого/фрагментов.
4. **Администратор нажимает** «Опубликовать» или «Отклонить».
5. **Система запрашивает** причину отклонения и не даёт завершить действие без причины.
6. **Система переводит** документ в статус `published` и включает его в выдачу/ответы, либо в `rejected` и исключает.
7. **Система показывает** ошибку доступа, если действие выполняет не администратор.
8. **Администратор удаляет** документ и подтверждает действие.
9. **Система удаляет** файл и связанные данные (чанки/индексы) и обновляет список.


### Сценарий 10 — FR10: Управление пользователями + сброс пароля

1. **Администратор открывает** раздел «Пользователи» в админ-панели.
2. **Система отображает** список пользователей с ролью (user/admin) и статусом (активен/заблокирован).
3. **Администратор ищет** пользователя по email и открывает карточку пользователя.
4. **Администратор изменяет** роль пользователя и сохраняет изменения.
5. **Система показывает** ошибку и отменяет действие, если попытаться снять роль у последнего администратора.
6. **Администратор блокирует** или разблокирует пользователя и подтверждает действие.
7. **Администратор нажимает** «Сбросить пароль» и подтверждает действие.
8. **Система генерирует** временный пароль, сохраняет его (в виде хэша), включает флаг «требуется смена пароля» и **показывает** временный пароль администратору.
9. **Система при первом входе** пользователя с временным паролем принудительно переводит его на экран смены пароля и не даёт работать с системой, пока пароль не будет изменён.

